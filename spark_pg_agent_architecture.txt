+------------------------------------------------------------------------------------------------------------------------------+
|                                           Spark PostgreSQL Agent Architecture                                              |
+------------------------------------------------------------------------------------------------------------------------------+
                                                          |
                                                          |
              +--------------------------------------+    |    +---------------------------------------+
              |                                      |    |    |                                       |
              |            Interface Layer           |<---+--->|             CLI Module                |
              |                                      |         |                                       |
              +--------------------------------------+         +---------------------------------------+
                               |                                              ^
                               v                                              |
+------------------------------------------------------------------------------------------------------------------------------+
|                                                    Core Layer                                                                 |
|                                                                                                                              |
|   +---------------------------------------+                              +--------------------------------------------+       |
|   |         TransformationAgent           |<----------------------------->|                 AgentMemory                |       |
|   |---------------------------------------|                              |--------------------------------------------|       |
|   | - process_request()                   |                              | - conversation_history                     |       |
|   | - _process_transformation()           |                              | - previous_transformations                 |       |
|   | - _is_relative_request()              |                              | - transformation_steps                     |       |
|   | - confirm_result()                    |                              | - named_references                         |       |
|   | - _extract_tables_used()              |                              | - find_related_transformation()            |       |
|   | - _summarize_result()                 |                              | - get_step()                               |       |
|   +---------------------------------------+                              | - _create_reference_markers()              |       |
|     |              |               |                                     +--------------------------------------------+       |
|     |              |               |                                                                                         |
|     |              |               v                                                                                         |
|     |              |      +------------------------+                                                                         |
|     |              |      |    SchemaMemory        |                                                                         |
|     |              |      |------------------------|                                                                         |
|     |              |      | - table_schemas        |                                                                         |
|     |              |      | - get_all_table_names()|                                                                         |
|     |              |      | - get_table_columns()  |                                                                         |
|     |              |      +------------------------+                                                                         |
|     |              |               ^                                                                                         |
|     |              |               |                                                                                         |
|     |              v               |                                                                                         |
|     |     +------------------+     |                                                                                         |
|     |     | DatabaseManager  |-----|                                                                                         |
|     |     |------------------|                                                                                               |
|     |     | - connect()      |                                                                                               |
|     |     | - load_schema()  |                                                                                               |
|     |     | - test_connection|                                                                                               |
|     |     +------------------+                                                                                               |
|     |                                                                                                                        |
|     v                                                                                                                        |
| +------------------------------------------------------------------------------------------------------+                    |
| |                                    MultiPhaseLLMCompiler                                              |                    |
| |-----------------------------------------------------------------------------------------------------|                    |
| |  +-------------------+  +------------------+  +----------------------+  +------------------------+   |                    |
| |  | schema_analysis   |  | plan_generation  |  | code_generation      |  | code_review            |   |                    |
| |  |-------------------|  |------------------|  |----------------------|  |------------------------|   |                    |
| |  | - Identify tables |  | - Create step-   |  | - Standard           |  | - Validate code        |   |                    |
| |  | - Extract columns |  |   by-step plan   |  | - context_aware_     |  | - Fix common issues    |   |                    |
| |  | - Identify joins  |  | - SQL to PySpark |  | - refinement_        |  | - Review for issues    |   |                    |
| |  +-------------------+  +------------------+  +----------------------+  +------------------------+   |                    |
| |                                              ^                                                      |                    |
| |                                              |                                                      |                    |
| |  +---------------------------+               |                +-------------------+                 |                    |
| |  |    CompilationContext     |---------------+                | LLMProvider       |                 |                    |
| |  |---------------------------|                                |-------------------|                 |                    |
| |  | - user_request            |                                | - get_completion()|                 |                    |
| |  | - schema_memory           |                                | - get_chat_      |                 |                    |
| |  | - postgres_config         |                                |   completion()    |                 |                    |
| |  | - tables_referenced       |                                +-------------------+                 |                    |
| |  | - columns_referenced      |                                                                      |                    |
| |  | - phase_results           |                                                                      |                    |
| |  +---------------------------+                                                                      |                    |
| +------------------------------------------------------------------------------------------------------+                    |
|                                                                                                                              |
|     |                                                                                                                        |
|     v                                                                                                                        |
| +-----------------------------------+                                +------------------------------------+                   |
| |          SparkExecutor            |                                |           ResultValidator           |                  |
| |-----------------------------------|                                |------------------------------------|                  |
| | - execute()                       |                                | - validate()                        |                  |
| | - shutdown()                      |                                | - check_result_structure()          |                  |
| | - setup_spark_session()           |                                | - validate_result_data()            |                  |
| +-----------------------------------+                                +------------------------------------+                   |
|                                                                                                                              |
+------------------------------------------------------------------------------------------------------------------------------+
                             |                                            ^
                             v                                            |
+------------------------------------------------------------------------------------------------------------------------------+
|                                                   External Systems                                                            |
|                                                                                                                              |
|  +------------------------------+              +-----------------------------+            +--------------------------------+  |
|  |       PostgreSQL Database    |              |      Spark Cluster          |            |         LLM Services           |  |
|  |------------------------------|              |-----------------------------|            |--------------------------------|  |
|  | - Tables                     |              | - Distributed Data          |            | - OpenAI                       |  |
|  | - Schemas                    |              | - Processing                |            | - Anthropic                    |  |
|  | - Metadata                   |              |                             |            | - Other providers              |  |
|  +------------------------------+              +-----------------------------+            +--------------------------------+  |
|                                                                                                                              |
+------------------------------------------------------------------------------------------------------------------------------+ 